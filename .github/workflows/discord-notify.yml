name: Discord notify

on:
  push:
    branches: ["main"]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Send pretty Discord embed
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          AVATAR: ${{ github.actor_avatar_url }}
          COMPARE_URL: ${{ github.event.compare }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
          REF: ${{ github.ref_name }}
        run: |
          set -euo pipefail

          count=$(echo "$COMMITS_JSON" | jq 'length')

          commits=$(echo "$COMMITS_JSON" | jq -r '
            .[0:10][] |
            "`" + .id[0:7] + "` " +
            (.message | split("\n")[0]) +
            " â€“ " + (.author.name // "unknown")
          ' | paste -sd '\n' -)

          jq -n \
            --arg title "[$REPO:$REF] $count new commits" \
            --arg desc "$commits" \
            --arg url "$COMPARE_URL" \
            --arg avatar "$AVATAR" \
            '{
              embeds: [{
                title: $title,
                url: $url,
                description: $desc,
                color: 3066993,
                thumbnail: { url: $avatar },
                footer: { text: "GitHub" }
              }]
            }' \
          | curl -sS -H "Content-Type: application/json" -d @- "$WEBHOOK_URL"
