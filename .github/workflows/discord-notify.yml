name: Discord notify

on:
  push:
    branches: ["main"]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send push message to Discord
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          COMPARE_URL: ${{ github.event.compare }}
          COMMITS_JSON: ${{ toJson(github.event.commits) }}
          HEAD_MSG: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail

          # count commits in this push
          commit_count="$(echo "$COMMITS_JSON" | jq 'length')"

          # head commit first line
          head_line="$(printf "%s" "${HEAD_MSG:-}" | head -n 1)"

          # up to 10 commit lines: - <shortsha> <title>
          commit_lines="$(echo "$COMMITS_JSON" | jq -r '.[0:10][] | "- " + (.id[0:7]) + " " + (.message | split("\n")[0])')"

          # build ONE-LINE content string with \n (Discord renders newlines)
          content="**[push]** \`$REPO\`\nBy: **$ACTOR**\nCommits in this push: **$commit_count**\nCompare: $COMPARE_URL\nLatest: **$head_line**\n$commit_lines"

          # send as JSON safely (jq escapes everything)
          jq -n --arg content "$content" '{content:$content}' \
            | curl -sS -H "Content-Type: application/json" -d @- "$WEBHOOK_URL" >/dev/null
